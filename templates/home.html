{% extends "layout.html" %}
{% block content %}

<div class="flex justify-between mb-4">
    <a href="?month={{ prev_month.strftime('%Y-%m') }}">‚Üê Prev</a>
    <h2 class="font-bold">{{ current_month.strftime('%B %Y') }}</h2>
    <a href="/home">Today</a>
</div>

<form method="POST" class="mb-4 flex gap-2">
    <input type="hidden" name="action" value="add">
    <input name="habit_name" placeholder="Habit" required class="border p-1">
    <select name="frequency" class="border p-1">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
    </select>
    <button class="bg-green-500 text-white px-2">Add</button>
</form>

<div class="grid grid-cols-7 gap-2">
{% for day in month_days %}
<div class="p-2 rounded day-box
{% if day.date > today %}bg-gray-300
{% elif day.entries|selectattr('completed')|list|length == day.entries|length and day.entries|length>0 %}bg-green-400
{% elif day.entries|selectattr('completed')|list|length > 0 %}bg-yellow-300
{% else %}bg-red-400{% endif %}">

<strong>{{ day.date.day }}</strong>

{% for e in day.entries %}
<label class="block">
<input type="checkbox" data-entry="{{ e.id }}" {% if e.completed %}checked{% endif %}>
{{ e.habit_id | habit_name }}
</label>
{% endfor %}

<textarea class="w-full text-sm mt-2 reason"
data-date="{{ day.date }}">{{ day.reason }}</textarea>
</div>
{% endfor %}
</div>

<script>
document.querySelectorAll('input[type=checkbox]').forEach(cb=>{
cb.onchange=()=>{
fetch("/update_completion",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({entry_id:cb.dataset.entry,completed:cb.checked?1:0})});
let box=cb.closest(".day-box");
let c=box.querySelectorAll("input:checked").length;
let t=box.querySelectorAll("input").length;
box.className="p-2 rounded day-box "+(c==t&&t?"bg-green-400":c?"bg-yellow-300":"bg-red-400");
}});
document.querySelectorAll(".reason").forEach(r=>{
r.onblur=()=>fetch("/update_reason",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({date:r.dataset.date,reason:r.value})});
});
</script>

{% endblock %}
